# Preparing Your Data for Classification


```mlx
filename = "/Users/andressacolin/Downloads/DL and CV/DL for Computer Vision/Data/MathWorks Created/Fasteners/Classification/Train";
imdsFasteners = imageDatastore(filename,"IncludeSubfolders",true,"LabelSource","foldernames")
```

--- 

# Investigating Your Data
It's essential to understand your data before training. 
Investigating the datastore can tell you important information, such as the number of images in your training dataset:

```mlx
numImgs = length(imdsFasteners.Files)

% And the number of images per class using the countEachLabel function:

countEachLabel(imdsFasteners)

img = read(imdsFasteners);
imshow(img)

size(img)

img = readimage(imdsFasteners,475);
imshow(img)
```
---


# Creating Training and Validation Sets
As you saw in "Preparing Your Data for Classification," creating a randomized validation set is crucial to avoid overfitting your model to the training data. You saw above that imdsFasteners has sufficient images of each class. Setting aside 20% of the training images for validation creates a reasonably-sized validation set.
splitEachLabel creates two new image datastores, one for training and one for validation:
```mlx

[imdsTrain,imdsValidation] = splitEachLabel(imdsFasteners,0.8,"randomized");
```
---

# Building Your Network Layers
In the video, you saw how to create a simple CNN in the Deep Network Designer App and export the code to the workspace. The exported code, autogenerated by the app, appears below:
```mlx
net = dlnetwork;

tempNet = [
    imageInputLayer([227 227 3],"Name","imageinput")
    convolution2dLayer([3 3],32,"Name","conv","Padding","same")
    reluLayer("Name","relu")
    maxPooling2dLayer([5 5],"Name","maxpool","Padding","same")
    fullyConnectedLayer(19,"Name","fc")
    softmaxLayer("Name","softmax")];
net = addLayers(net,tempNet);

% clean up helper variable
clear tempNet;

net = initialize(net);
```
---

# Exploring Network Layers

Exporting and looking at each layer may not be practical for larger and more complex networks. Fortunately, you can access individual layers and see useful details using dot notation:
```mlx
% Image input layer
net.Layers(1).Name
net.Layers(1).InputSize
```
In classification, no matter how large the network, the fully-connected layer (fc) is usually second-from-last:
```mlx 
% Fully-connected layer
net.Layers(end-1).Name
net.Layers(end-1).OutputSize    % Number of classes
```
---
# Resizing Your Training Data
The following code resizes the training data to meet the expected input size specified in the image input layer:
```mlx
augTrain = augmentedImageDatastore([227,227],imdsTrain);
augVal = augmentedImageDatastore([227,227],imdsValidation);
```
Setting Your Training Options
Here, we leave most training options as their defaults. However, you'll see how to choose model options and when to update them to improve your model later in this course.
```mlx
opts = trainingOptions("adam","ValidationData",augVal,...
    "Shuffle","every-epoch","Plots","training-progress");
```
---
# Training Your Network
Checking the box below will train a new classification model for the fasteners dataset. This may take some time (about 50 minutes on my CPU).
Otherwise, the following code will load the network we trained in the "Creating and Training a CNN for Classification" video, available in the course files. 
```mlx
% Check the box to train a new network. Otherwise, load the trained network
% from the course files
trainNew = false;
if trainNew
    net = trainnet(augTrain,net,"crossentropy",opts);
else
    load fastenerSimpleCNNClassifier.mat
end
```
---
# Evaluating Your Network
Use your trained network to classify the test set. Then, compare these predictions to the actual test labels to determine the model's test accuracy.
```mlx
filenameTest = "";
imdsTest = imageDatastore(filenameTest,"IncludeSubfolders",true,"LabelSource","foldernames");

augTest = augmentedImageDatastore([227,227],imdsTest);
Notice how the prediction scores are returned as an  matrix where  is the number images and  is how many classes the model is trained to identify (in this case 19). In other words, there is a score for each class for each image.
% Return a score for each image for each class
testPreds = minibatchpredict(net,augTest)
```
You can see that many of the predicted scores are 1, meaning the model is very confident the image is a member of that class.
Now, determine the model's predicted class label for each image by finding the class with the highest score.
```mlx
classes = categories(imdsTest.Labels);
testPredsClass = scores2label(testPreds,classes)
Compare the predicted labels to the true labels to determine the model's test accuracy
testAccuracy = nnz(testPredsClass == imdsTest.Labels)/length(testPreds)
Investigate how many images of each label were correctly and incorrectly classified using a confusion chart. You may need to press the  button, opening the figure in a new window, to see it better.
confusionchart(imdsTest.Labels,testPredsClass)
```
Copyright 2024 The MathWorks, Inc.
